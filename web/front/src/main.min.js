"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();!function(){window.log=function(e){console.log(e)};var e=[],t=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"sortFormFields",value:function(e){var t={};for(var i in Object.keys(e)){var s=e[i].property,n=e[i];"0 Or More"===n.cardinality?(t[s]=t[s]||[],t[s].push(n)):t[s]=n}return t}},{key:"getFirstFieldValue",value:function(e,t){return"array"==typeof t[e]?t[e]:t[e][0]}}]),e}();window.GVCarto=function(){function i(e){_classCallCheck(this,i),window.gvc=this,this.mainComponent=e,this.firstSearch=!0,this.$window=$(window),this.buildingSelectedAll="partout",this.buildingSelected=this.buildingSelectedAll,this.$loadingSpinner=$("#gv-spinner"),this.sfClient=new t,this.$gvMap=$(document.getElementById("gv-map")),this.$tabs=$(".nav-tabs"),this.searchTypeCurrent="all",this.searchTypes={Personne:"Personne",Organisation:"Organisation"},"127.0.0.1"===window.location.hostname&&window.document.body.classList.add("dev-env"),this.setSearchType(this.searchTypeCurrent),this.ajaxMultiple({buildings:"/webservice/building"},this.start)}return _createClass(i,[{key:"ajaxMultiple",value:function(e,t){var i=0,s={},n=this;for(var r in e)i++,$.ajax({url:e[r],complete:function(e){return function(r){i--,s[e]=JSON.parse(r.responseText),0===i&&t.call(n,s)}}(r)})}},{key:"start",value:function(t){var i=this;this.buildings=t.buildings;for(var s in this.buildings)this.buildings[s].key=s;this.domSearchTextInput=this.domId("searchText"),this.domSearchResults=this.domId("searchResults"),this.stateSet("waiting");var n=this.searchEvent.bind(this);this.listen("searchForm","submit",function(e){i.domSearchTextInput.blur(),i.scrollToSearchResults(),n(e)}),this.isReady=!0;var r;this.listen("searchText","keyup",function(){r&&window.clearTimeout(r),r=window.setTimeout(n,500)});for(var a in e)e[a]()}},{key:"stateSet",value:function(e){if(this.stateCurrent!==e){var t=e.charAt(0).toUpperCase()+e.slice(1);if(this.stateCurrent){var i=this.stateCurrent.charAt(0).toUpperCase()+this.stateCurrent.slice(1);this["state"+i+"Exit"](),this.stateCurrent=null}this["state"+t+"Init"]()!==!1&&(this.stateCurrent=e)}}},{key:"setSearchType",value:function(e){e!==this.searchTypeCurrent&&this.$tabs.find("li[rel="+this.searchTypeCurrent+"]").removeClass("active"),this.searchTypeCurrent=e,this.$tabs.find("li[rel="+e+"]").addClass("active"),gvc.renderSearchResult()}},{key:"loadingPageContentStart",value:function(){this.$loadingSpinner.show()}},{key:"loadingPageContentStop",value:function(){this.$loadingSpinner.hide()}},{key:"stateWaitingInit",value:function(){gvmap.mapShowBuildingPinAll()}},{key:"stateWaitingExit",value:function(){}},{key:"stateSearchInit",value:function(){if(!this.domSearchTextInput.value)return this.stateSet("waiting"),!1}},{key:"stateSearchExit",value:function(){}},{key:"scrollToSearchResults",value:function(e){this.$window.scrollTo($("#searchTabs").offset().top-150,{duration:1e3,easing:"easeOutQuad",complete:e})}},{key:"searchEvent",value:function(e){e&&e.preventDefault();var t=this.domSearchTextInput.value;this.search(t,this.buildingSelected)}},{key:"searchRouteChange",value:function(e,t){this.firstSearch&&(this.domSearchTextInput.value=e,this.buildingSelected=gvc.buildingSelectedAll,this.firstSearch=!1),this.search(e,t)}},{key:"textRemove",value:function(e,t){return e.replace(new RegExp(t,"g"),"")}},{key:"search",value:function(e,t){var i=this;if(this.stateSet("search"),e=e.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,""),this.lastSearchTerm!==e||this.lastSearchBuilding!==t){this.lastSearchTerm=e,this.lastSearchBuilding=t,this.mainComponent.set("route.path","/rechercher/"+(t||"partout")+"/"+e),this.domId("searchResults"),this.domSearchResults.innerHTML="",this.$tabs.find("li .counter").hide(),$("#gv-results-empty, #gv-results-error").hide(),this.loadingPageContentStart();var s=function(e){i.loadingPageContentStop(),i.renderSearchResult(e.responseJSON)};this.searchQueryLastComplete=s,this.loadingPageContentStart(),$.ajax({url:"/webservice/search?b="+encodeURIComponent(t)+"&t="+encodeURIComponent(e),dataType:"json",complete:function(e){s===i.searchQueryLastComplete&&s(e)}})}}},{key:"renderSearchResult",value:function(e){if(e=e||this.renderSearchResultResponse||{},this.renderSearchResultResponse=e,e.error)$("#gv-results-error").show();else if(e.results&&e.results.length){this.domSearchResults.innerHTML="",gvmap.mapShowBuildingPin(this.buildingSelected);var t={};for(var i in e.results){var s=e.results[i];if(t[s.type]=t[s.type]||0,t[s.type]++,this.searchTypes[s.type]&&("all"===this.searchTypeCurrent||s.type===this.searchTypeCurrent)){var n=document.createElement("gv-results-item");$.extend(n,s),this.domSearchResults.appendChild(n)}}this.$tabs.find("li .counter").html(0);var r=Object.keys(t),a=0;for(var l in r){var o=r[l],u=t[o]||0;this.$tabs.find('li[rel="'+o+'"] .counter').html(u),a+=u}this.$tabs.find('li[rel="all"] .counter').html(a),this.$tabs.find("li .counter").show()}else $("#gv-results-empty").show()}},{key:"listen",value:function(e,t,i){if(!Array.isArray(t))return this.domId(e).addEventListener(t,i);for(var s in t)this.listen(e,t[s],i)}},{key:"domId",value:function(e){return document.getElementById(e)}},{key:"dom",value:function(e){return document.querySelectorAll(e)}}]),i}(),window.GVCarto.ready=function(t){window.gvc&&window.gvc.isReady?t():e.push(t)}}();
//# sourceMappingURL=main.min.js.map
