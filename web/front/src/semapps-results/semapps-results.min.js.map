{"version":3,"sources":["web/front/src/semapps-results/semapps-results.js"],"names":["Polymer","is","properties","tabFirst","type","Object","value","plural","icon","typeSelected","String","tabs","Array","tabsRegistry","results","searchLastTerm","route","observer","attached","_this","this","semapps","domSearchResults","domId","domLoadingSpinner","$searchThemeFilter","$","SemAppsCarto","ready","typeSel","each","entities","data","counter","push","selectType","tabRegister","component","tab","selection","searchRender","_routeChanged","_this2","prefix","map","zoomGlobal","window","split","path","log","search","term","building","_this3","filterUri","val","searchLastFilter","replace","searchError","noResult","style","display","complete","responseJSON","searchQueryLastComplete","ajax","encodeURIComponent","response","_this4","length","set","totalCounter","typesCounter","resultTemps","renderSearchResultResponse","error","pinHideAll","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","Symbol","iterator","next","done","result","pins","getAddressToCreatePoint","pinShow","err","return","key","keys","resultsTitle","all","entity","setTimeout","$$","classList","remove","add"],"mappings":"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","file":"semapps-results.min.js","sourcesContent":["Polymer({\n    is: 'semapps-results',\n    properties: {\n        tabFirst: {\n            type: Object,\n            value: {\n                type: 'all',\n                plural: 'Tous',\n                icon: 'list'\n            }\n        },\n        typeSelected: {\n            type: String\n        },\n        tabs: {\n            type: Array,\n            value: []\n        },\n        tabsRegistry: {\n            type: Object,\n            value: {}\n        },\n        results: {\n            type: Array,\n            value: []\n        },\n        searchLastTerm: {\n            type: String,\n            value: null\n        },\n        route: {\n            type: Object,\n            observer: '_routeChanged'\n        }\n    },\n\n    attached() {\n        \"use strict\";\n        semapps.results = this;\n        this.domSearchResults = semapps.domId('searchResults');\n        this.domLoadingSpinner = semapps.domId('searchLoadingSpinner');\n        this.$searchThemeFilter = $('#searchThemeFilter');\n        // Wait global settings.\n        SemAppsCarto.ready(() => {\n            let tabs = [];\n            let typeSel = '';\n            $.each(semapps.entities, (type, data) => {\n                data.counter = 0;\n                typeSel = (typeSel == '') ? type : typeSel;\n                tabs.push(data);\n            });\n            this.tabs = tabs;\n            // Activate first tab by default.\n            this.selectType(typeSel);\n        });\n    },\n\n    tabRegister(type, component) {\n        \"use strict\";\n        this.tabsRegistry[type] = component;\n        // Refresh selected tab.\n        this.selectType(this.typeSelected);\n    },\n\n    selectType(tab)  {\n        \"use strict\";\n        this.selection(tab);\n        // Render results.\n        this.searchRender();\n    },\n\n    _routeChanged: function (data) {\n        // We are on the search mode.\n        if (data.prefix === '/rechercher') {\n            semapps.map.zoomGlobal();\n            // Route change may be fired before init.\n            window.SemAppsCarto.ready(() => {\n                let split = data.path.split('/');\n                log(split)\n                this.search(split[1]);\n            });\n        }\n    },\n\n    search(term, building) {\n        \"use strict\";\n        let filterUri = this.$searchThemeFilter.val();\n\n        // Term and has not changed.\n        if (semapps.searchLastTerm === term &&\n            // Filter has not changed.\n            semapps.searchLastFilter === filterUri) {\n            // (maybe building changed).\n            this.searchRender();\n            return;\n        }\n        // Cleanup term to avoid search errors.\n        semapps.searchLastTerm =\n            term = (term || '').replace(/[`~!@#$%^&*()_|+\\-=?;:'\",.<>\\{\\}\\[\\]\\\\\\/]/gi, '');\n        // Save filter.\n        semapps.searchLastFilter = filterUri;\n        this.searchError =\n            this.noResult = false;\n        // Empty page.\n        this.results = [];\n        // Show spinner.\n        this.domLoadingSpinner.style.display = 'block';\n        // Build callback function.\n        let complete = (data) => {\n            this.domLoadingSpinner.style.display = 'none';\n            this.searchRender(data.responseJSON);\n        };\n        // Say that this function is the\n        // only one we expect to be executed.\n        // It prevent to parse multiple responses.\n        this.searchQueryLastComplete = complete;\n        semapps.ajax('webservice/search?' +\n            'term=' + encodeURIComponent(term) +\n            '&filter=' + encodeURIComponent(semapps.searchLastFilter), (data) => {\n            \"use strict\";\n            // Check that we are on the last callback expected.\n            complete === this.searchQueryLastComplete\n            // Continue.\n            && complete(data);\n        });\n    },\n\n    searchRender(response) {\n        \"use strict\";\n        let results = [];\n        // Reset again if just rendering fired.\n        this.searchError =\n            this.noResult = false;\n        this.results.length = 0;\n        this.set('results', []);\n        let totalCounter = 0;\n        let typesCounter = {};\n        let resultTemps = {};\n        // Allow empty response.\n        response = response || this.renderSearchResultResponse || {};\n        // Save last data for potential reload.\n        this.renderSearchResultResponse = response;\n\n        if (response.error) {\n            this.searchError = true;\n        }\n        else if (response.results) {\n            semapps.map.pinHideAll();\n\n            for (let result of response.results) {\n                // Data is allowed.\n                if(semapps.entities[result.type]){\n                    log(result.type);\n                    typesCounter[result.type] = typesCounter[result.type] || 0;\n                    typesCounter[result.type]++;\n                    totalCounter++;\n\n                    if (typeof resultTemps[result.type] === 'undefined')\n                        resultTemps[result.type] = [];\n                    resultTemps[result.type].push(result);\n                    log(resultTemps);\n                    if(result[\"address\"]){\n                        if( semapps.map.pins[result[\"uri\"]] === undefined){\n                            semapps.getAddressToCreatePoint(result[\"address\"],result[\"title\"],result[\"type\"],result[\"uri\"]);\n                        }\n                        else{\n                            semapps.map.pinShow(result[\"uri\"]);\n                        }\n                    }\n                }\n            }\n            // semapps.map.pinShowAll();\n            if(typeof resultTemps[this.typeSelected] === 'undefined' ){\n                // Deselect tab if current.\n                let key = Object.keys(resultTemps)[0];\n                this.selection(key);\n                results =(typeof resultTemps[this.typeSelected] !== 'undefined' )? resultTemps[Object.keys(resultTemps)[0]] : [];\n            }\n            else{\n                results = resultTemps[this.typeSelected];\n            }\n            // Create title.\n            let resultsTitle = '';\n            // Results number.\n            resultsTitle += (results.length) ? results.length + ' résultats ' : 'Aucun résultat  ';\n            // Building.\n            // Display title.\n            this.resultsTitle = resultsTitle;\n\n            // Display no results section or not.\n            this.noResult = results.length === 0;\n\n        }\n\n        this.tabsRegistry.all && (this.tabsRegistry.all.counter = totalCounter);\n        for (let entity in semapps.entities){\n            this.tabsRegistry[entity] && (this.tabsRegistry[entity].counter = typesCounter[entity] || 0);\n\n        }\n        setTimeout(() => {\n            this.set('results', results);\n        }, 100);\n    },\n\n    selection(val){\n        if (this.typeSelected && this.tabsRegistry[val]) {\n            this.tabsRegistry[this.typeSelected].$$('li').classList.remove('active');\n        }\n        // Save.\n        this.typeSelected = val;\n        // It may not be already created.\n        if (this.tabsRegistry[val]) {\n            this.tabsRegistry[val].$$('li').classList.add('active');\n        }\n    }\n});\n"]}