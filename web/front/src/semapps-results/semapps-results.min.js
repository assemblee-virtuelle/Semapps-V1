"use strict";Polymer({is:"semapps-results",properties:{tabFirst:{type:Object,value:{type:"all",plural:"Tous",icon:"list"}},typeSelected:{type:String},tabs:{type:Array,value:[]},tabsRegistry:{type:Object,value:{}},results:{type:Array,value:[]},searchLastTerm:{type:String,value:null},route:{type:Object,observer:"_routeChanged"}},attached:function(){var e=this;semapps.results=this,this.domSearchResults=semapps.domId("searchResults"),this.domLoadingSpinner=semapps.domId("searchLoadingSpinner"),this.$searchThemeFilter=$("#searchThemeFilter"),SemAppsCarto.ready(function(){var s=[],t="";$.each(semapps.entities,function(e,i){i.counter=0,t=""==t?e:t,s.push(i)}),e.tabs=s,e.selectType(t)})},tabRegister:function(e,s){this.tabsRegistry[e]=s,this.selectType(this.typeSelected)},selectType:function(e){this.selection(e),this.searchRender()},_routeChanged:function(e){var s=this;"/rechercher"===e.prefix&&window.SemAppsCarto.ready(function(){var t=e.path.split("/");s.search(t[2],t[1])})},search:function(e,s){var t=this,i=this.$searchThemeFilter.val();if(semapps.searchLastTerm===e&&semapps.searchLastFilter===i)return void this.searchRender();semapps.searchLastTerm=e=(e||"").replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,""),semapps.searchLastFilter=i,this.searchError=this.noResult=!1,this.results=[],this.domLoadingSpinner.style.display="block";var r=function(e){t.domLoadingSpinner.style.display="none",t.searchRender(e.responseJSON)};this.searchQueryLastComplete=r,semapps.ajax("webservice/search?t="+encodeURIComponent(e)+"&f="+encodeURIComponent(semapps.searchLastFilter),function(e){r===t.searchQueryLastComplete&&r(e)})},searchRender:function(e){var s=this,t=[];this.searchError=this.noResult=!1,this.results.length=0;var i=[];this.set("results",[]);var r=0,a={},l={},p={};if(e=e||this.renderSearchResultResponse||{},this.renderSearchResultResponse=e,e.error)this.searchError=!0;else if(e.results){semapps.map.pinHideAll();var n=!0,d=!1,h=void 0;try{for(var o,c=e.results[Symbol.iterator]();!(n=(o=c.next()).done);n=!0){var u=o.value;-1!==$.inArray(u.type,semapps.allowedType)&&(semapps.buildings[u.building]&&(l[u.building]=l[u.building]||0,l[u.building]++),semapps.buildingSelected!==semapps.buildingSelectedAll&&u.building!==semapps.buildingSelected||(a[u.type]=a[u.type]||0,a[u.type]++,r++,void 0===p[u.type]&&(p[u.type]=[]),p[u.type].push(u)),void 0!==u.address&&(void 0===i[u.address]?(i[u.address]=[],i[u.address].text='<span class="pin-content" style="display: none">'+u.address+"</span>"+u.title):i[u.address].text+=u.title)),"http://virtual-assembly.org/pair#Address"===u.type&&(void 0===i[u.uri]&&(i[u.uri]=[]),i[u.uri].latitude=u.latitude,i[u.uri].longitude=u.longitude)}}catch(e){d=!0,h=e}finally{try{!n&&c.return&&c.return()}finally{if(d)throw h}}for(var y in i)i.hasOwnProperty(y)&&semapps.map.pinShow(i[y].latitude,i[y].longitude,y,i[y].text);if(void 0===p[this.typeSelected]){var m=Object.keys(p)[0];this.selection(m),t=void 0!==p[this.typeSelected]?p[Object.keys(p)[0]]:[]}else t=p[this.typeSelected];var g="";g+=t.length?t.length+" résultats dans ":"Aucun résultat dans ",g+=semapps.buildingSelected===semapps.buildingSelectedAll?"tous les bâtiments":"le bâtiment "+semapps.buildings[semapps.buildingSelected].title,this.resultsTitle=g,this.noResult=0===t.length}this.tabsRegistry.all&&(this.tabsRegistry.all.counter=r);for(var b=0;b<semapps.allowedType.length;b++)this.tabsRegistry[semapps.allowedType[b]]&&(this.tabsRegistry[semapps.allowedType[b]].counter=a[semapps.allowedType[b]]||0);setTimeout(function(){s.set("results",t)},100)},selection:function(e){this.typeSelected&&this.tabsRegistry[e]&&this.tabsRegistry[this.typeSelected].$$("li").classList.remove("active"),this.typeSelected=e,log(this.typeSelected),this.tabsRegistry[e]&&this.tabsRegistry[e].$$("li").classList.add("active")}});
//# sourceMappingURL=semapps-results.min.js.map
