{"version":3,"sources":["web/front/src/gv-results/gv-results.js"],"names":["Polymer","is","properties","tabFirst","type","Object","value","plural","icon","typeSelected","String","tabs","Array","tabsRegistry","results","searchLastTerm","route","observer","attached","_this","this","gvc","domSearchResults","domId","domLoadingSpinner","GVCarto","ready","typeSel","$","each","entities","data","counter","push","selectType","tabRegister","component","tab","$$","classList","remove","add","searchRender","_routeChanged","_this2","prefix","window","split","path","buildingSelected","searchLastBuilding","buildings","buildingSelectedAll","search","term","_this3","replace","searchError","noResult","style","display","complete","responseJSON","searchQueryLastComplete","ajax","encodeURIComponent","response","_this4","length","set","totalCounter","typesCounter","buildingsCounter","renderSearchResultResponse","error","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","Symbol","iterator","next","done","result","searchTypes","building","err","return","resultsTitle","title","map","pinHideAll","pinShow","all","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","keys","setTimeout"],"mappings":"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","file":"gv-results.min.js","sourcesContent":["Polymer({\r\n  is: 'gv-results',\r\n  properties: {\r\n    tabFirst: {\r\n      type: Object,\r\n      value: {\r\n        type: 'all',\r\n        plural: 'Tous',\r\n        icon: 'list'\r\n      }\r\n    },\r\n    typeSelected: {\r\n      type: String\r\n    },\r\n    tabs: {\r\n      type: Array,\r\n      value: []\r\n    },\r\n    tabsRegistry: {\r\n      type: Object,\r\n      value: {}\r\n    },\r\n    results: {\r\n      type: Array,\r\n      value: []\r\n    },\r\n    searchLastTerm: {\r\n      type: String,\r\n      value: null\r\n    },\r\n    route: {\r\n      type: Object,\r\n      observer: '_routeChanged'\r\n    }\r\n  },\r\n\r\n  attached() {\r\n    \"use strict\";\r\n    gvc.results = this;\r\n    this.domSearchResults = gvc.domId('searchResults');\r\n    this.domLoadingSpinner = gvc.domId('searchLoadingSpinner');\r\n    // Wait global settings.\r\n    GVCarto.ready(() => {\r\n      let tabs = [];\r\n      let typeSel ='';\r\n      $.each(gvc.entities, (type, data) => {\r\n        data.counter = 0;\r\n        typeSel = (typeSel == '')? type : typeSel;\r\n        tabs.push(data);\r\n      });\r\n      this.tabs = tabs;\r\n      // Activate first tab by default.\r\n      this.selectType(typeSel);\r\n    });\r\n  },\r\n\r\n  tabRegister(type, component) {\r\n    \"use strict\";\r\n    this.tabsRegistry[type] = component;\r\n    // Refresh selected tab.\r\n    this.selectType(this.typeSelected);\r\n  },\r\n\r\n  selectType(tab)  {\r\n    \"use strict\";\r\n    // Deselect tab if current.\r\n    if (this.typeSelected && this.tabsRegistry[tab]) {\r\n      this.tabsRegistry[this.typeSelected].$$('li').classList.remove('active');\r\n    }\r\n    // Save.\r\n    this.typeSelected = tab;\r\n    // It may not be already created.\r\n    if (this.tabsRegistry[tab]) {\r\n      this.tabsRegistry[tab].$$('li').classList.add('active');\r\n    }\r\n    // Render results.\r\n    this.searchRender();\r\n  },\r\n\r\n  _routeChanged: function (data) {\r\n    //// We are on the search mode.\r\n    if (data.prefix === '/rechercher') {\r\n      // Route change may be fired before init.\r\n      window.GVCarto.ready(() => {\r\n        let split = data.path.split('/');\r\n        gvc.buildingSelected =\r\n          gvc.searchLastBuilding = (gvc.buildings[split[1]] ? split[1] : gvc.buildingSelectedAll);\r\n        // Term has not changed (maybe building changed).\r\n        if (gvc.searchLastTerm === split[2]) {\r\n          this.searchRender();\r\n        }\r\n        else {\r\n          this.search(split[2], split[1]);\r\n        }\r\n      });\r\n    }\r\n  },\r\n\r\n  search(term) {\r\n    \"use strict\";\r\n    // Cleanup term to avoid search errors.\r\n    gvc.searchLastTerm =\r\n      term = (term || '').replace(/[`~!@#$%^&*()_|+\\-=?;:'\",.<>\\{\\}\\[\\]\\\\\\/]/gi, '');\r\n    this.searchError =\r\n      this.noResult = false;\r\n    // Empty page.\r\n    this.results = [];\r\n    // Show spinner.\r\n    this.domLoadingSpinner.style.display = 'block';\r\n    // Build callback function.\r\n    let complete = (data) => {\r\n      this.domLoadingSpinner.style.display = 'none';\r\n      this.searchRender(data.responseJSON);\r\n    };\r\n    // Say that this function is the\r\n    // only one we expect to be executed.\r\n    // It prevent to parse multiple responses.\r\n    this.searchQueryLastComplete = complete;\r\n    gvc.ajax('webservice/search?t=' + encodeURIComponent(term), (data) => {\r\n      \"use strict\";\r\n      // Check that we are on the last callback expected.\r\n      complete === this.searchQueryLastComplete\r\n        // Continue.\r\n      && complete(data);\r\n    });\r\n  },\r\n\r\n  searchRender(response) {\r\n    \"use strict\";\r\n    let results = [];\r\n    // Reset again if just rendering fired.\r\n    this.searchError =\r\n      this.noResult = false;\r\n    this.results.length = 0;\r\n    this.set('results', []);\r\n    let totalCounter = 0;\r\n    let typesCounter = {};\r\n    let buildingsCounter = {};\r\n\r\n    // Allow empty response.\r\n    response = response || this.renderSearchResultResponse || {};\r\n    // Save last data for potential reload.\r\n    this.renderSearchResultResponse = response;\r\n\r\n    if (response.error) {\r\n      this.searchError = true;\r\n    }\r\n    else if (response.results) {\r\n\r\n      for (let result of response.results) {\r\n        // Data is allowed.\r\n        if (gvc.searchTypes[result.type]) {\r\n\r\n          // Count results by building.\r\n          if (gvc.buildings[result.building]) {\r\n            buildingsCounter[result.building] = buildingsCounter[result.building] || 0;\r\n            buildingsCounter[result.building]++;\r\n          }\r\n          // This building is enabled.\r\n          if (gvc.buildingSelected === gvc.buildingSelectedAll || result.building === gvc.buildingSelected) {\r\n            // Count results.\r\n            typesCounter[result.type] = typesCounter[result.type] || 0;\r\n            typesCounter[result.type]++;\r\n            totalCounter++;\r\n            // This tab is enabled.\r\n            if (this.typeSelected === 'all' || result.type === this.typeSelected) {\r\n              results.push(result);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Create title.\r\n      let resultsTitle = '';\r\n      // Results number.\r\n      resultsTitle += (results.length) ? results.length + ' résultats dans ' : 'Aucun résultat dans ';\r\n      // Building.\r\n      resultsTitle += (gvc.buildingSelected === gvc.buildingSelectedAll) ? 'tous les bâtiments' : 'le bâtiment ' + gvc.buildings[gvc.buildingSelected].title;\r\n      // Display title.\r\n      this.resultsTitle = resultsTitle;\r\n      \r\n      // Display no results section or not.\r\n      this.noResult = results.length === 0;\r\n\r\n      // Show pins with results only.\r\n      gvc.map.pinHideAll();\r\n      $.each(gvc.buildings, (building) => {\r\n        if (buildingsCounter[building] || building === gvc.buildingSelected) {\r\n          gvc.map.pinShow(building, buildingsCounter[building] || 0);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.tabsRegistry.all && (this.tabsRegistry.all.counter = totalCounter);\r\n    for (let type of Object.keys(gvc.searchTypes)) {\r\n      this.tabsRegistry[type] && (this.tabsRegistry[type].counter = typesCounter[type] || 0);\r\n    }\r\n\r\n    setTimeout(() => {\r\n      this.set('results', results);\r\n    }, 100);\r\n  }\r\n});\r\n"]}