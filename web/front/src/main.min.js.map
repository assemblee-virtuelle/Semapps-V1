{"version":3,"sources":["web/front/src/main.js"],"names":["window","log","m","console","readyCallbacks","GVCarto","_class","mainComponent","_classCallCheck","this","gvc","firstSearch","$window","$","buildingSelected","$loadingSpinner","location","hostname","document","body","classList","add","ajaxMultiple","buildings","start","_createClass","key","value","sources","callback","ajaxCounter","allData","self","ajax","url","complete","e","JSON","parse","responseText","call","data","_this","domSearchTextInput","domId","domSearchResults","stateSet","callbackSearchEvent","searchEvent","bind","listen","blur","scrollToSearchResults","isReady","timeout","clearTimeout","setTimeout","i","stateName","stateCurrent","nameCapitalized","charAt","toUpperCase","slice","nameCurrentCapitalized","show","hide","scrollTo","offset","top","duration","easing","preventDefault","term","search","building","char","replace","RegExp","_this2","lastSearchTerm","lastSearchBuilding","set","innerHTML","loadingPageContentStart","loadingPageContentStop","renderSearchResult","responseJSON","searchQueryLastComplete","encodeURIComponent","dataType","response","error","results","length","result","createElement","label","uri","appendChild","id","event","Array","isArray","addEventListener","getElementById","selector","querySelectorAll","ready","push"],"mappings":"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","file":"main.min.js","sourcesContent":["(function () {\n  'use strict';\n\n  // Devel\n  window.log = (m) => {\n    console.log(m);\n  };\n\n  var readyCallbacks = [];\n\n  window.GVCarto = class {\n\n    constructor(mainComponent) {\n      window.gvc = this;\n      this.mainComponent = mainComponent;\n      this.firstSearch = true;\n      this.$window = $(window);\n      this.buildingSelected = 'partout';\n      this.$loadingSpinner = $('#gv-spinner');\n\n      // Special class for dev env.\n      if (window.location.hostname === '127.0.0.1') {\n        window.document.body.classList.add('dev-env');\n      }\n\n      this.ajaxMultiple({\n        buildings: '/webservice/building'\n      }, this.start);\n    }\n\n    ajaxMultiple(sources, callback) {\n      \"use strict\";\n      var ajaxCounter = 0;\n      var allData = {};\n      var self = this;\n      for (var key in sources) {\n        ajaxCounter++;\n        $.ajax({\n          url: sources[key],\n          complete: function (key) {\n            return function (e) {\n              ajaxCounter--;\n              allData[key] = JSON.parse(e.responseText);\n              // Final callback.\n              if (ajaxCounter === 0) {\n                callback.call(self, allData);\n              }\n            }\n          }(key)\n        });\n      }\n    }\n\n    start(data) {\n      \"use strict\";\n      this.buildings = data.buildings;\n      // Shortcuts.\n      this.domSearchTextInput = this.domId('searchText');\n      this.domSearchResults = this.domId('searchResults');\n      this.stateSet('waiting');\n\n      // Listeners.\n      var callbackSearchEvent = this.searchEvent.bind(this);\n      // Click on submit button.\n      this.listen('searchForm', 'submit', (e) => {\n        this.domSearchTextInput.blur();\n        this.scrollToSearchResults();\n        callbackSearchEvent(e);\n      });\n      // Launch callbacks\n      this.isReady = true;\n      var timeout;\n      // Type in search field.\n      this.listen('searchText', 'keyup', () => {\n        if (timeout) {\n          window.clearTimeout(timeout);\n        }\n        // Avoid to make too much requests when typing.\n        timeout = window.setTimeout(callbackSearchEvent, 500);\n      });\n\n      // Ready callbacks.\n      for (let i in readyCallbacks) {\n        readyCallbacks[i]();\n      }\n    }\n\n    stateSet(stateName) {\n      if (this.stateCurrent !== stateName) {\n        let nameCapitalized = stateName.charAt(0).toUpperCase() + stateName.slice(1);\n        if (this.stateCurrent) {\n          let nameCurrentCapitalized = this.stateCurrent.charAt(0).toUpperCase() + this.stateCurrent.slice(1);\n          this['state' + nameCurrentCapitalized + 'Exit']();\n          this.stateCurrent = null;\n        }\n        // Callback should not return false if success.\n        if (this['state' + nameCapitalized + 'Init']() !== false) {\n          this.stateCurrent = stateName;\n        }\n      }\n    }\n\n    loadingPageContentStart() {\n      this.$loadingSpinner.show();\n    }\n\n    loadingPageContentStop() {\n      this.$loadingSpinner.hide();\n    }\n\n    /* -- Waiting --*/\n    stateWaitingInit() {\n\n    }\n\n    stateWaitingExit() {\n\n    }\n\n    /* -- Search -- */\n\n    stateSearchInit() {\n      if (!this.domSearchTextInput.value) {\n        this.stateSet('waiting');\n        // Block saving current state.\n        return false;\n      }\n    }\n\n    stateSearchExit() {\n\n    }\n\n    scrollToSearchResults(complete) {\n      this.$window.scrollTo($('#searchTabs').offset().top - 150, {\n        duration: 1000,\n        easing: 'easeOutQuad',\n        complete: complete\n      });\n    }\n\n    searchEvent(e) {\n      // Event may be missing.\n      e && e.preventDefault();\n      var term = this.domSearchTextInput.value;\n      this.search(term, this.buildingSelected);\n    }\n\n    searchRouteChange(term, building) {\n      if (this.firstSearch) {\n        // Set value to input (used at first page load)\n        this.domSearchTextInput.value = term;\n        this.buildingSelected = 'building';\n        this.firstSearch = false;\n      }\n\n      // Launch search.\n      this.search(term, building);\n    }\n\n    textRemove(term, char) {\n      return term.replace(new RegExp(char, 'g'), '');\n    }\n\n    search(term, building) {\n      this.stateSet('search');\n\n      term = term.replace(/[`~!@#$%^&*()_|+\\-=?;:'\",.<>\\{\\}\\[\\]\\\\\\/]/gi, '');\n\n      // Prevent recursions due to route event changes,\n      // and also prevent to search two times the same values.\n      if (this.lastSearchTerm === term && this.lastSearchBuilding === building) {\n        return;\n      }\n\n      this.lastSearchTerm = term;\n      this.lastSearchBuilding = building;\n      this.mainComponent.set('route.path', '/rechercher/' + (building || 'partout') + '/' + term);\n\n      // Empty content.\n      this.domId('searchResults');\n      this.domSearchResults.innerHTML = '';\n\n      // Hide all results.\n      $('#gv-results-empty, #gv-results-error').hide();\n      this.loadingPageContentStart();\n\n      // Build callback function.\n      let complete = (data) => {\n        this.loadingPageContentStop();\n        this.renderSearchResult(data.responseJSON);\n      };\n\n      // Say that this function is the\n      // only one we expect to be executed.\n      // It prevent to parse multiple responses.\n      this.searchQueryLastComplete = complete;\n\n      this.loadingPageContentStart();\n\n      $.ajax({\n        url: '/webservice/search?b=' + encodeURIComponent(building) + '&t=' + encodeURIComponent(term),\n        dataType: 'json',\n        complete: (data) => {\n          \"use strict\";\n          // Check that we are on the last callback expected.\n          complete === this.searchQueryLastComplete\n            // Continue.\n          && complete(data);\n        }\n      });\n    }\n\n    renderSearchResult(response) {\n      \"use strict\";\n      if (response.error) {\n        $('#gv-results-error').show();\n      }\n      else if (!response.results.length) {\n        $('#gv-results-empty').show();\n      }\n      else {\n        for (let i in response.results) {\n          let data = response.results[i];\n          let result = document.createElement('gv-results-item');\n          result.label = data.label;\n          result.uri = data.uri;\n          this.domSearchResults.appendChild(result);\n        }\n      }\n    }\n\n    listen(id, event, callback) {\n      // Support list of events names.\n      if (Array.isArray(event)) {\n        for (let i in event) {\n          this.listen(id, event[i], callback);\n        }\n        return;\n      }\n      return this.domId(id).addEventListener(event, callback);\n    }\n\n    domId(id) {\n      return document.getElementById(id);\n    }\n\n    dom(selector) {\n      return document.querySelectorAll(selector);\n    }\n  };\n\n  window.GVCarto.ready = function (callback) {\n    if (!window.gvc || !window.gvc.isReady) {\n      readyCallbacks.push(callback);\n    }\n    else {\n      callback();\n    }\n  };\n}());\n"]}